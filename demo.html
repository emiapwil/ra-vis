<!DOCTYPE html>
<html lang="en-us">

    <head>
        <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
        <script src="/assets/js/jquery-1.11.0.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <style>
         select {
             width: 100%;
         }

         textarea {
             width: 100%;
             min-height: 200px;
         }
         .node {
             fill: #ccc;
             stroke: #fff;
             stroke-width: 2px;
         }

         .node[selected=true] {
             fill: #000;
         }

         .link {
             stroke: #777;
             stroke-width: 2px;
         }
        </style>
    </head>

    <body>
        <div class="col-md-6">
            <p><label>Please select the demo topology</label></p>
            <select id="topolist" onchange="selectTopology(this.value)">
            </select>
            <p><label>Please type the route algebra expression</label></p>
            <textarea type="text" onchange="setRouteAlgebraExpr(this.value)">
            </textarea>
            <input type="submit" value="Submit" onclick="submitQuery()"/>
        </div>
        <div class="col-md-6">
            <svg></svg>
        </div>
        <script>
         const topoListUrl = 'http://localhost:5000/topologylist.json'
         fetch(topoListUrl).then(r => r.json())
                           .then(topoList => {
                               topoList.forEach(topo => d3.select('select')
                                                          .append('option')
                                                          .attr('value', topo)
                                                          .text(topo))
                           });

         var draw = function(width, height, data) {
             var nodes = data.nodes.map(d => Object.create(d));
             var links = data.links.map(d => Object.create(d));

             var svg = d3.select('svg')
                         .attr('width', width)
                         .attr('height', height);

             // Now we create a force layout object and define its properties.
             // Those include the dimensions of the visualization and the arrays
             // of nodes and links.

             const simulation = d3.forceSimulation(nodes)
                                  .force("link", d3.forceLink(links))
                                  .force("charge", d3.forceManyBody());

             svg.selectAll('.link')
                .data([])
                .exit()
                .remove();
             svg.selectAll('.node')
                .data([])
                .exit()
                .remove();
             var link = svg.selectAll('.link')
                           .data(links)
                           .enter().append('line')
                           .attr('class', 'link')
                           .attr('x1', d => d.source.x)
                           .attr('y1', d => d.source.y)
                           .attr('x2', d => d.target.x)
                           .attr('y2', d => d.target.y)
                           .attr('id', d => d.id);

             var node = svg.selectAll('.node')
                           .data(nodes)
                           .enter().append('circle')
                           .attr('class', 'node')
                           .attr('r', d => d.r)
                           .attr('cx', d => d.x)
                           .attr('cy', d => d.y)
                           .attr('id', d => d.index)
                           .attr('label', d => d.label);

             d3.selectAll('.node')
               .on('mouseover', d => { console.log(d) })
               .on('mouseout', d => {console.log(d) });
             d3.selectAll('.link')
               .on('mouseover', d => { console.log(d) })
               .on('mouseout', d => {console.log(d) });

         };

         var selected = [];
         var speed = 250;
         function highlight(path) {
             var t = d3.transition()
                       .ease(d3.easeLinear);
             console.log(path);
             const svg = d3.select('svg');
             svg.selectAll('.node')
                .filter(d => (selected.findIndex(e => e == d.index) >= 0))
                .attr('selected', 'false');
             path.forEach(function (node, index) {
                 svg.selectAll('.node')
                    .filter(d => (node == d.index))
                    .transition()
                    .delay((index + 1) * speed)
                    .attr('selected', 'true');
             });
             selected = path;
         };

         var width = 640, height = 480;

         // Define the data for the example. In general, a force layout
         // requires two data arrays. The first array, here named `nodes`,
         // contains the object that are the focal point of the visualization.
         // The second array, called `links` below, identifies all the links
         // between the nodes. (The more mathematical term is "edges.")

         // For the simplest possible example we only define two nodes. As
         // far as D3 is concerned, nodes are arbitrary objects. Normally the
         // objects wouldn't be initialized with `x` and `y` properties like
         // we're doing below. When those properties are present, they tell
         // D3 where to place the nodes before the force layout starts its
         // magic. More typically, they're left out of the nodes and D3 picks
         // random locations for each node. We're defining them here so we can
         // get a consistent application of the layout which lets us see the
         // effects of different properties.

         function selectTopology(topo) {
             console.log(topo);
             const url = 'http://localhost:5000/topology/' + topo + '.json';
             fetch(url).then(r => r.json())
                       .then(data => draw(width, height, data));
         }

         var queryForm = function () {
             var value = $('textarea').value;

             function setValue(v) {
                 console.log("set value: " + v);
                 value = v;
             }

             function submit() {
                 const url = 'http://localhost:5000/query';
                 fetch(url, {
                     body: value,
                     method: 'POST'
                 }).then(r => r.json())
                 .then(path => highlight(path));
             }

             return {
                 setValue: setValue,
                 submit: submit
             };

         }();

         function setRouteAlgebraExpr(value) {
             queryForm.setValue(value);
         };

         function submitQuery() {
             queryForm.submit();
         };

        </script>
    </body>
</html>
